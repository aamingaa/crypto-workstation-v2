# closed='left' vs closed='right' å¯¹ç‰¹å¾ç”Ÿæˆçš„å½±å“åˆ†æ

## æ•°æ®æµç¨‹å›é¡¾

```
åŸå§‹æ•°æ®(z_raw, 15min) 
  â†’ æ—¶é—´åç§» 
  â†’ resample(closed, label) 
  â†’ æ¢å¤åç§»
  â†’ coarse_bars(1h)
  â†’ BaseFeatureè®¡ç®—ç‰¹å¾
  â†’ features_df
  â†’ ç”¨features_df.indexå»z_rawä¸­å–ä»·æ ¼
  â†’ è®¡ç®—returnæ ‡ç­¾
```

---

## å…³é”®å½±å“åˆ†æ

### 1. ç²—ç²’åº¦OHLCæ•°æ®çš„å·®å¼‚

#### åœºæ™¯ç¤ºä¾‹
- **åŸå§‹æ•°æ®ï¼ˆ15åˆ†é’Ÿï¼‰**: `[9:00, 9:15, 9:30, 9:45, 10:00, 10:15, ...]`
- **ç›®æ ‡**: 1å°æ—¶ç²—ç²’åº¦ï¼Œ`offset=0`

#### closed='left', label='left' âœ…ï¼ˆæ­£ç¡®ï¼‰

```python
åŒºé—´: [9:00, 10:00)  # å·¦é—­å³å¼€
åŒ…å«çš„æ•°æ®ç‚¹: 9:00, 9:15, 9:30, 9:45
ç»“æœæ—¶é—´æˆ³: 9:00

èšåˆç»“æœ:
  - open: 9:00çš„open
  - high: max(9:00, 9:15, 9:30, 9:45çš„high)
  - low: min(9:00, 9:15, 9:30, 9:45çš„low)
  - close: 9:45çš„close
  - volume: sum(...)
```

#### closed='right', label='right' âŒï¼ˆä¹‹å‰çš„é”™è¯¯ï¼‰

```python
åŒºé—´: (9:00, 10:00]  # å·¦å¼€å³é—­
åŒ…å«çš„æ•°æ®ç‚¹: 9:15, 9:30, 9:45, 10:00
ç»“æœæ—¶é—´æˆ³: 10:00

èšåˆç»“æœ:
  - open: 9:15çš„openï¼ˆä¸¢å¤±äº†9:00ï¼ï¼‰
  - high: max(9:15, 9:30, 9:45, 10:00çš„high)
  - low: min(9:15, 9:30, 9:45, 10:00çš„low)
  - close: 10:00çš„close
  - volume: sum(...)
```

### 2. æ—¶é—´æˆ³å¯¹é½çš„å·®å¼‚

#### closed='left', label='left' âœ…

```
coarse_bars.index: [9:00, 10:00, 11:00, 12:00, ...]
å«ä¹‰: æ¯ä¸ªæ—¶é—´æˆ³è¡¨ç¤ºè¯¥å°æ—¶çš„èµ·å§‹

ç‰¹å¾æ—¶é—´æˆ³: [9:00, 10:00, 11:00, ...]
å«ä¹‰: 9:00çš„ç‰¹å¾ = åŸºäº[9:00-10:00)çš„æ•°æ®è®¡ç®—
```

#### closed='right', label='right' âŒ

```
coarse_bars.index: [10:00, 11:00, 12:00, 13:00, ...]
å«ä¹‰: æ¯ä¸ªæ—¶é—´æˆ³è¡¨ç¤ºè¯¥å°æ—¶çš„ç»“æŸ

ç‰¹å¾æ—¶é—´æˆ³: [10:00, 11:00, 12:00, ...]
å«ä¹‰: 10:00çš„ç‰¹å¾ = åŸºäº(9:00-10:00]çš„æ•°æ®è®¡ç®—
```

---

## å…·ä½“å½±å“

### å½±å“1: ç‰¹å¾å€¼çš„å˜åŒ– âš ï¸ **å½±å“ç¨‹åº¦: ä¸­ç­‰**

**åŸå› **: OHLCæ•°æ®ä¸åŒ â†’ æŠ€æœ¯æŒ‡æ ‡ä¸åŒ

```python
# ä¾‹å¦‚ï¼šç§»åŠ¨å¹³å‡çº¿
# closed='left': MA = mean([9:00, 9:15, 9:30, 9:45çš„close])
# closed='right': MA = mean([9:15, 9:30, 9:45, 10:00çš„close])
```

**å…·ä½“å½±å“çš„ç‰¹å¾**:
- âœ… æ‰€æœ‰åŸºäºä»·æ ¼çš„æŒ‡æ ‡ï¼ˆMA, EMA, MACD, RSI, ATRç­‰ï¼‰
- âœ… æˆäº¤é‡ç›¸å…³æŒ‡æ ‡
- âœ… æ³¢åŠ¨ç‡æŒ‡æ ‡
- âœ… åŠ¨é‡æŒ‡æ ‡

**å½±å“ç¨‹åº¦**:
- å•ä¸ªç‰¹å¾å€¼çš„å˜åŒ–é€šå¸¸åœ¨ **1-5%** èŒƒå›´å†…
- å› ä¸ºåªæ˜¯è¾¹ç•Œç‚¹ä¸åŒï¼ˆ4ä¸ªç‚¹ä¸­çš„1ä¸ªä¸åŒï¼‰

### å½±å“2: ç‰¹å¾-æ ‡ç­¾æ—¶é—´å¯¹é½ âš ï¸âš ï¸ **å½±å“ç¨‹åº¦: è¾ƒå¤§**

è¿™æ˜¯**æœ€å…³é”®**çš„å½±å“ï¼

#### ä»£ç ä¸­çš„å¯¹é½é€»è¾‘

```python
# Line 811-821
row_timestamps = features_df.index  # ç‰¹å¾çš„æ—¶é—´æˆ³

# è·å–å½“å‰æ—¶åˆ»çš„ä»·æ ¼ï¼ˆç”¨äºè®¡ç®—returnï¼‰
t_prices = z_raw['c'].reindex(row_timestamps)
o_prices = z_raw['o'].reindex(row_timestamps)

# è®¡ç®—æœªæ¥æ—¶åˆ»
future_prediction_timestamps = row_timestamps + prediction_horizon_td

# è·å–æœªæ¥ä»·æ ¼
t_future_prices = z_raw['c'].reindex(future_prediction_timestamps)

# è®¡ç®—return
return_p = (t_future_prices.values / t_prices.values)
```

#### é—®é¢˜åˆ†æ

**åœºæ™¯**: `offset=0`, ç²—ç²’åº¦=1å°æ—¶, æ»šåŠ¨æ­¥é•¿=15åˆ†é’Ÿ

##### closed='left', label='left' âœ…

```
features_df.index = 9:00
  â†’ ç‰¹å¾åŸºäº [9:00-10:00) çš„æ•°æ®
  â†’ t_prices = z_raw['c'][9:00]  â† æ­£ç¡®ï¼9:00æ˜¯åŒºé—´çš„ç¬¬ä¸€ä¸ªç‚¹
  â†’ é€»è¾‘ä¸€è‡´ï¼šç”¨9:00çš„ä»·æ ¼é¢„æµ‹æœªæ¥

æ—¶é—´è¯­ä¹‰:
  ç‰¹å¾: [9:00-10:00) çš„å¸‚åœºçŠ¶æ€
  å½“å‰ä»·æ ¼: 9:00
  é¢„æµ‹: 9:00 â†’ æœªæ¥Nå°æ—¶çš„return
```

##### closed='right', label='right' âŒ

```
features_df.index = 10:00
  â†’ ç‰¹å¾åŸºäº (9:00-10:00] çš„æ•°æ®
  â†’ t_prices = z_raw['c'][10:00]  â† é—®é¢˜ï¼10:00æ˜¯åŒºé—´çš„æœ€åä¸€ä¸ªç‚¹
  â†’ é€»è¾‘ä¸ä¸€è‡´ï¼šç‰¹å¾åŸºäº(9:00-10:00]ï¼Œä½†ç”¨10:00çš„ä»·æ ¼

æ—¶é—´è¯­ä¹‰:
  ç‰¹å¾: (9:00-10:00] çš„å¸‚åœºçŠ¶æ€
  å½“å‰ä»·æ ¼: 10:00
  é¢„æµ‹: 10:00 â†’ æœªæ¥Nå°æ—¶çš„return
  
é—®é¢˜: 
  - ç‰¹å¾ä¸­å·²ç»åŒ…å«äº†10:00çš„closeä»·æ ¼ï¼ˆä½œä¸ºè¯¥å°æ—¶çš„æ”¶ç›˜ï¼‰
  - ä½†æ ‡ç­¾åˆç”¨10:00ä½œä¸º"å½“å‰"ä»·æ ¼
  - å­˜åœ¨è½»å¾®çš„ä¿¡æ¯æ³„éœ²é£é™©
```

### å½±å“3: è¾¹ç•Œæ•°æ®ä¸¢å¤± âš ï¸âš ï¸âš ï¸ **å½±å“ç¨‹åº¦: ä¸¥é‡**

#### closed='left', label='left' âœ…

```
åŸå§‹æ•°æ®: 9:00å¼€å§‹
èšåˆç»“æœ: 
  - ç¬¬ä¸€ä¸ªæ¡¶: 9:00 â†’ åŒ…å« [9:00, 9:15, 9:30, 9:45]
  - æ²¡æœ‰æ•°æ®ä¸¢å¤±
```

#### closed='right', label='right' âŒ

```
åŸå§‹æ•°æ®: 9:00å¼€å§‹
èšåˆç»“æœ:
  - ç¬¬ä¸€ä¸ªæ¡¶: 10:00 â†’ åŒ…å« [9:15, 9:30, 9:45, 10:00]
  - 9:00çš„æ•°æ®è¢«ä¸¢å¤±ï¼
  
å½±å“: 
  - ä¸¢å¤±æœ€å¼€å§‹çš„ä¸€ä¸ªç²—ç²’åº¦æ¡¶
  - å›æµ‹æ—¶ç¼ºå°‘åˆå§‹æ•°æ®
  - ç»Ÿè®¡åˆ†ææœ‰åå·®
```

### å½±å“4: å¤šç»„offsetçš„å¯¹é½é—®é¢˜ âš ï¸âš ï¸ **å½±å“ç¨‹åº¦: è¾ƒå¤§**

#### æ‚¨çš„ä»£ç é€»è¾‘

```python
# 4ç»„offset: 0min, 15min, 30min, 45min
for i in range(4):
    offset = pd.Timedelta(minutes=i * 15)
    # åç§» â†’ resample â†’ æ¢å¤
    z_raw_offset.index = z_raw_offset.index - offset
    coarse_bars = resample(..., closed, label)
    coarse_bars.index = coarse_bars.index + offset
```

#### closed='left', label='left' âœ…

```
ç»„0 (offset=0):   [9:00-10:00) â†’ 9:00
ç»„1 (offset=15):  [9:15-10:15) â†’ 9:15
ç»„2 (offset=30):  [9:30-10:30) â†’ 9:30
ç»„3 (offset=45):  [9:45-10:45) â†’ 9:45

ç»“æœ: å®Œç¾è¦†ç›–æ‰€æœ‰15åˆ†é’Ÿæ—¶é—´ç‚¹
```

#### closed='right', label='right' âŒ

```
ç»„0 (offset=0):   (9:00-10:00] â†’ 10:00
ç»„1 (offset=15):  (9:15-10:15] â†’ 10:15
ç»„2 (offset=30):  (9:30-10:30] â†’ 10:30
ç»„3 (offset=45):  (9:45-10:45] â†’ 10:45

ç»“æœ: 
  - æ—¶é—´æˆ³éƒ½åç§»äº†ï¼ˆæ ‡è®°ä¸ºåŒºé—´å³ç«¯ï¼‰
  - ä¸¢å¤±äº†9:00, 9:15, 9:30, 9:45çš„æ¡¶
  - å¤šå‡ºäº†10:00, 10:15, 10:30, 10:45çš„æ¡¶
```

---

## é‡åŒ–å½±å“è¯„ä¼°

### 1. è®­ç»ƒé›†/æµ‹è¯•é›†å¤§å°å˜åŒ–

```python
# å‡è®¾åŸå§‹æ•°æ®: 2å¹´ï¼Œæ¯å¤©24å°æ—¶ï¼Œ15åˆ†é’Ÿæ•°æ®
# åŸå§‹æ•°æ®ç‚¹: 2 * 365 * 24 * 4 = 70,080 ä¸ª

# ç²—ç²’åº¦1å°æ—¶ï¼Œ4ç»„offset
# é¢„æœŸèšåˆå: 70,080 / 4 * 4 = 70,080 ä¸ªæ ·æœ¬

# closed='left' âœ…: çº¦70,000ä¸ªæ ·æœ¬ï¼ˆè¾¹ç•Œç•¥æœ‰æŸå¤±ï¼‰
# closed='right' âŒ: çº¦69,500ä¸ªæ ·æœ¬ï¼ˆå¤šæŸå¤±çº¦500ä¸ªæ ·æœ¬ï¼‰

å·®å¼‚: çº¦0.5-1%çš„æ•°æ®é‡æŸå¤±
```

### 2. ç‰¹å¾å€¼åˆ†å¸ƒå˜åŒ–

```python
# å¯¹äºæŠ€æœ¯æŒ‡æ ‡ï¼ˆå¦‚RSIï¼‰
# closed='left' â†’ closed='right' å¯¼è‡´çš„å˜åŒ–:

å¹³å‡å˜åŒ–: 0.5-2%
æœ€å¤§å˜åŒ–: 5-10%ï¼ˆåœ¨æç«¯æ³¢åŠ¨æ—¶ï¼‰

# ç¤ºä¾‹:
# closed='left': RSI = 65.3
# closed='right': RSI = 64.8
# å·®å¼‚: 0.5ç‚¹ (çº¦0.8%)
```

### 3. æ¨¡å‹æ€§èƒ½å½±å“

**ç†è®ºå½±å“**:
- IC (ä¿¡æ¯ç³»æ•°): **Â±0.01-0.03** çš„å˜åŒ–
- Sharpe ratio: **Â±0.05-0.15** çš„å˜åŒ–
- å›æµ‹æ”¶ç›Š: **Â±1-5%** çš„å˜åŒ–

**åŸå› **:
1. ç‰¹å¾-æ ‡ç­¾æ—¶é—´å¯¹é½æ›´åˆç†
2. è¾¹ç•Œæ•°æ®ä¸å†ä¸¢å¤±
3. ç‰¹å¾è®¡ç®—é€»è¾‘æ›´ç¬¦åˆé‡‘èè¯­ä¹‰

---

## å®é™…æµ‹è¯•å»ºè®®

### å¿«é€ŸéªŒè¯è„šæœ¬

```python
import pandas as pd
import numpy as np

# åˆ›å»ºæµ‹è¯•æ•°æ®
timestamps = pd.date_range('2024-01-01 09:00', periods=100, freq='15min')
z_raw = pd.DataFrame({
    'o': np.random.randn(100) + 100,
    'h': np.random.randn(100) + 101,
    'l': np.random.randn(100) + 99,
    'c': np.random.randn(100) + 100,
    'vol': np.random.randint(1000, 2000, 100),
    'vol_ccy': np.random.randint(10000, 20000, 100),
    'trades': np.random.randint(50, 150, 100),
}, index=timestamps)

# æµ‹è¯•ä¸¤ç§æ–¹æ³•
def test_resample(closed, label):
    coarse = z_raw.resample('1H', closed=closed, label=label).agg({
        'o': 'first', 'h': 'max', 'l': 'min', 'c': 'last',
        'vol': 'sum', 'vol_ccy': 'sum', 'trades': 'sum'
    })
    return coarse

result_left = test_resample('left', 'left')
result_right = test_resample('right', 'right')

print(f"åŸå§‹æ•°æ®: {len(z_raw)} è¡Œ")
print(f"closed='left': {len(result_left)} è¡Œ")
print(f"closed='right': {len(result_right)} è¡Œ")
print(f"\nç¬¬ä¸€ä¸ªæ—¶é—´æˆ³:")
print(f"  åŸå§‹: {z_raw.index[0]}")
print(f"  left: {result_left.index[0]}")
print(f"  right: {result_right.index[0]}")
print(f"\nOHLCå·®å¼‚:")
print(f"  left open: {result_left.iloc[0]['o']}")
print(f"  right open: {result_right.iloc[0]['o']}")
print(f"  å·®å¼‚: {abs(result_left.iloc[0]['o'] - result_right.iloc[0]['o'])}")
```

### å®Œæ•´æµ‹è¯•æµç¨‹

1. **å¤‡ä»½å½“å‰æ¨¡å‹**: ä¿å­˜å½“å‰ä½¿ç”¨ `closed='right'` çš„æ¨¡å‹ç»“æœ
2. **åˆ‡æ¢åˆ° `closed='left'`**: ä¿®æ”¹ä»£ç 
3. **é‡æ–°è®­ç»ƒ**: ä½¿ç”¨ç›¸åŒçš„å‚æ•°é‡æ–°è®­ç»ƒ
4. **å¯¹æ¯”ç»“æœ**:
   ```python
   # å¯¹æ¯”æ ·æœ¬æ•°é‡
   # å¯¹æ¯”ç‰¹å¾åˆ†å¸ƒ
   # å¯¹æ¯”IC/Sharpe
   # å¯¹æ¯”å›æµ‹æ›²çº¿
   ```

---

## æ€»ç»“

### æ”¹ä¸º closed='left', label='left' çš„å½±å“

| æ–¹é¢ | å½±å“ç¨‹åº¦ | å˜åŒ–æ–¹å‘ | è¯´æ˜ |
|------|---------|---------|------|
| **æ•°æ®é‡** | å° (+0.5-1%) | å¢åŠ  âœ… | æ¢å¤è¾¹ç•Œæ•°æ® |
| **ç‰¹å¾å€¼** | å° (1-5%) | å˜åŒ– âš ï¸ | OHLCç•¥æœ‰ä¸åŒ |
| **æ—¶é—´å¯¹é½** | å¤§ | æ”¹å–„ âœ…âœ… | è¯­ä¹‰æ›´åˆç† |
| **æ¨¡å‹æ€§èƒ½** | ä¸­ç­‰ | å¯èƒ½æ”¹å–„ âœ… | ç†è®ºä¸Šæ›´å‡†ç¡® |
| **å›æµ‹ç»“æœ** | ä¸­ç­‰ | å¯èƒ½æ”¹å–„ âœ… | æ›´ç¬¦åˆå®é™… |

### å»ºè®®è¡ŒåŠ¨

âœ… **ç«‹å³æ‰§è¡Œ**:
1. ç¡®è®¤ä¿®æ”¹å·²åº”ç”¨ï¼ˆå·²å®Œæˆ âœ“ï¼‰
2. è¿è¡Œå¿«é€ŸéªŒè¯è„šæœ¬
3. è§‚å¯Ÿæ ·æœ¬æ•°é‡å˜åŒ–

âš ï¸ **é‡ç‚¹å…³æ³¨**:
1. è®­ç»ƒé›†/æµ‹è¯•é›†å¤§å°æ˜¯å¦ç¬¦åˆé¢„æœŸ
2. ç‰¹å¾åˆ†å¸ƒæ˜¯å¦æœ‰å¼‚å¸¸
3. æ¨¡å‹æ€§èƒ½æŒ‡æ ‡å˜åŒ–

ğŸ“Š **é•¿æœŸç›‘æ§**:
1. å¯¹æ¯”æ–°æ—§æ¨¡å‹çš„å›æµ‹ç»“æœ
2. åœ¨å®ç›˜ä¸­éªŒè¯æ”¹è¿›æ•ˆæœ
3. æ›´æ–°æ–‡æ¡£å’Œæœ€ä½³å®è·µ

### é¢„æœŸç»“æœ

åŸºäºç†è®ºåˆ†æï¼Œæ”¹ä¸º `closed='left', label='left'` åï¼š
- âœ… **é€»è¾‘æ›´æ­£ç¡®**: ç¬¦åˆé‡‘èå¸‚åœºæ—¶é—´æˆ³è¯­ä¹‰
- âœ… **æ•°æ®æ›´å®Œæ•´**: ä¸ä¸¢å¤±è¾¹ç•Œæ•°æ®
- âœ… **å¯èƒ½æå‡æ€§èƒ½**: IC/Sharpeå¯èƒ½æœ‰å°å¹…æ”¹å–„
- âš ï¸ **éœ€è¦é‡æ–°è®­ç»ƒ**: ç‰¹å¾å€¼å‘ç”Ÿå˜åŒ–ï¼Œæ—§æ¨¡å‹ä¸å…¼å®¹

**é£é™©**: è¾ƒä½ã€‚è¿™æ˜¯ä¸€ä¸ªæ­£ç¡®æ€§ä¿®å¤ï¼Œä¸æ˜¯æ¿€è¿›çš„æ”¹åŠ¨ã€‚

