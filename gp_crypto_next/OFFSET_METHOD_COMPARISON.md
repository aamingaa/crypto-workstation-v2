# é™é¢‘æ–¹æ³•å¯¹æ¯”ï¼šæ—¶é—´åç§» vs offsetå‚æ•°

## å¿«é€Ÿå¯¹æ¯”

| ç‰¹æ€§ | æ—¶é—´åç§»æ–¹æ³•ï¼ˆæ—§ï¼‰ | offsetå‚æ•°æ–¹æ³•ï¼ˆæ–°âœ¨ï¼‰ |
|------|-----------------|-------------------|
| **å‡½æ•°å** | `data_prepare_coarse_grain_rolling` | `data_prepare_coarse_grain_rolling_offset` |
| **æ ¸å¿ƒå®ç°** | ä¿®æ”¹ç´¢å¼• â†’ resample â†’ æ¢å¤ç´¢å¼• | ç›´æ¥ä½¿ç”¨pandas offsetå‚æ•° |
| **ä»£ç å¤æ‚åº¦** | 3æ­¥æ“ä½œï¼Œè¾ƒå¤æ‚ | 1æ­¥å®Œæˆï¼Œç®€æ´ |
| **æ½œåœ¨é—®é¢˜** | è¾¹ç•Œé—®é¢˜ã€ç´¢å¼•ç²¾åº¦ | å‡ ä¹æ—  |
| **å¯è¯»æ€§** | â­â­â­ | â­â­â­â­â­ |
| **å®‰å…¨æ€§** | â­â­â­ | â­â­â­â­â­ |
| **æ€§èƒ½** | â­â­â­â­ | â­â­â­â­ |

---

## è¯¦ç»†å¯¹æ¯”

### 1. æ—¶é—´åç§»æ–¹æ³•ï¼ˆæ—§ï¼‰

```python
# ç¬¬iç»„ï¼Œåç§» i*15åˆ†é’Ÿ
offset = pd.Timedelta(minutes=i * 15)

# æ­¥éª¤1: å‘å‰åç§»æ—¶é—´ç´¢å¼•
z_raw_offset = z_raw.copy()
z_raw_offset.index = z_raw_offset.index - offset

# æ­¥éª¤2: resample
coarse_bars = resample(z_raw_offset, '1h', closed='right', label='right')

# æ­¥éª¤3: æ¢å¤æ—¶é—´ç´¢å¼•
coarse_bars.index = coarse_bars.index + offset

# æ­¥éª¤4: è¿‡æ»¤è¾¹ç•Œï¼ˆä¿®å¤è¾¹ç•Œé—®é¢˜ï¼‰
original_start = z_raw.index.min()
original_end = z_raw.index.max()
coarse_bars = coarse_bars[
    (coarse_bars.index >= original_start) & 
    (coarse_bars.index <= original_end)
]
```

**æ½œåœ¨é—®é¢˜ï¼š**
- ğŸ“Œ éœ€è¦copyæ•°æ®ï¼Œå¢åŠ å†…å­˜æ¶ˆè€—
- ğŸ“Œ ä¸‰æ­¥æ“ä½œï¼Œå®¹æ˜“åœ¨ä¸­é—´æ­¥éª¤å‡ºé”™
- ğŸ“Œ è¾¹ç•Œå¤„ç†å¤æ‚ï¼Œéœ€è¦é¢å¤–è¿‡æ»¤
- ğŸ“Œ æ—¶é—´ç²¾åº¦é—®é¢˜ï¼ˆè™½ç„¶æ¦‚ç‡å¾ˆå°ï¼‰

---

### 2. offsetå‚æ•°æ–¹æ³•ï¼ˆæ–°âœ¨ï¼‰

```python
# ç¬¬iç»„ï¼Œåç§» i*15åˆ†é’Ÿ
offset = pd.Timedelta(minutes=i * 15)

# ä¸€æ­¥å®Œæˆï¼šä½¿ç”¨pandasåŸç”Ÿoffsetå‚æ•°
coarse_bars = resample_with_offset(
    z_raw.copy(), 
    '1h', 
    offset=offset,  # ğŸ”‘ å…³é”®ï¼šç›´æ¥ä¼ å…¥offset
    closed='right', 
    label='right'
)

# è¿‡æ»¤è¾¹ç•Œï¼ˆä»ç„¶éœ€è¦ï¼‰
original_start = z_raw.index.min()
original_end = z_raw.index.max()
coarse_bars = coarse_bars[
    (coarse_bars.index >= original_start) & 
    (coarse_bars.index <= original_end)
]
```

**ä¼˜åŠ¿ï¼š**
- âœ… ä¸ä¿®æ”¹åŸå§‹ç´¢å¼•ï¼Œæ›´å®‰å…¨
- âœ… ä»£ç ç®€æ´ï¼Œæ„å›¾æ¸…æ™°
- âœ… ä½¿ç”¨pandaså®˜æ–¹APIï¼Œç¨³å®šå¯é 
- âœ… å‡å°‘ä¸­é—´æ­¥éª¤ï¼Œé™ä½å‡ºé”™æ¦‚ç‡

---

## æ ¸å¿ƒåŸç†ï¼šoffsetå‚æ•°å¦‚ä½•å·¥ä½œ

### é»˜è®¤è¡Œä¸ºï¼ˆæ— offsetï¼‰

```python
# æ—¶é—´åºåˆ—: 9:15, 9:30, 9:45, 10:00, 10:15, 10:30, 10:45, 11:00
df.resample('1H')

# ç»“æœæ¡¶ï¼ˆé»˜è®¤ä»epochå¼€å§‹å¯¹é½ï¼‰:
# [9:00-10:00): 9:15, 9:30, 9:45          â†’ æ ‡è®°ä¸º 9:00 æˆ– 10:00
# [10:00-11:00): 10:00, 10:15, 10:30, 10:45  â†’ æ ‡è®°ä¸º 10:00 æˆ– 11:00
```

### ä½¿ç”¨offsetå‚æ•°

```python
# offset = 15åˆ†é’Ÿ
df.resample('1H', offset='15min')

# ç»“æœæ¡¶ï¼ˆä»epoch+15minå¼€å§‹å¯¹é½ï¼‰:
# [9:15-10:15): 9:15, 9:30, 9:45, 10:00  â†’ æ ‡è®°ä¸º 9:15 æˆ– 10:15
# [10:15-11:15): 10:15, 10:30, 10:45, 11:00 â†’ æ ‡è®°ä¸º 10:15 æˆ– 11:15
```

**å…³é”®ç‚¹ï¼š**
- offsetæ”¹å˜çš„æ˜¯**æ¡¶çš„èµ·å§‹è¾¹ç•Œ**ï¼Œä¸æ˜¯æ•°æ®çš„æ—¶é—´æˆ³
- ç›¸å½“äºå‘Šè¯‰pandasï¼š"æŠŠæ¡¶çš„è¾¹ç•Œæ•´ä½“å¹³ç§»15åˆ†é’Ÿ"

---

## å®é™…æ•ˆæœå¯¹æ¯”

### åœºæ™¯ï¼š1å°æ—¶ç²—ç²’åº¦ + 15åˆ†é’Ÿæ»šåŠ¨æ­¥é•¿

```python
# åŸå§‹æ•°æ®ï¼ˆ15åˆ†é’Ÿï¼‰
timestamps = [9:00, 9:15, 9:30, 9:45, 10:00, 10:15, 10:30, 10:45, 11:00]

# éœ€è¦4ç»„ä¸åŒçš„æ¡¶æ¥è¦†ç›–æ‰€æœ‰æ—¶é—´ç‚¹ï¼š

# ç»„0: offset=0min
[9:00-10:00) â†’ 9:00, 9:15, 9:30, 9:45
[10:00-11:00) â†’ 10:00, 10:15, 10:30, 10:45

# ç»„1: offset=15min
[9:15-10:15) â†’ 9:15, 9:30, 9:45, 10:00
[10:15-11:15) â†’ 10:15, 10:30, 10:45, 11:00

# ç»„2: offset=30min
[9:30-10:30) â†’ 9:30, 9:45, 10:00, 10:15
[10:30-11:30) â†’ 10:30, 10:45, 11:00

# ç»„3: offset=45min
[9:45-10:45) â†’ 9:45, 10:00, 10:15, 10:30
[10:45-11:45) â†’ 10:45, 11:00
```

**ç»“æœï¼š**
- âœ… æ¯ä¸ª15åˆ†é’Ÿæ—¶é—´ç‚¹éƒ½æœ‰è‡ªå·±çš„1å°æ—¶ç²—ç²’åº¦ç‰¹å¾
- âœ… é¿å…äº†"æ‰€æœ‰9:xxçš„ç‚¹éƒ½ç”¨åŒä¸€ä¸ªæ¡¶"çš„é—®é¢˜
- âœ… å®ç°äº†çœŸæ­£çš„æ»‘åŠ¨çª—å£æ•ˆæœ

---

## è¾¹ç•Œé—®é¢˜å¯¹æ¯”

### æ—¶é—´åç§»æ–¹æ³•çš„è¾¹ç•Œé—®é¢˜

```python
# åŸå§‹æ•°æ®: 9:00 åˆ° 12:00
# offset = 30åˆ†é’Ÿ

# æ­¥éª¤1: ç´¢å¼•å‡å»30åˆ†é’Ÿ
# â†’ æ•°æ®å˜æˆ: 8:30 åˆ° 11:30

# æ­¥éª¤2: resampleï¼ˆ1å°æ—¶ï¼‰
# â†’ ç”Ÿæˆæ¡¶: 8:00, 9:00, 10:00, 11:00, 12:00

# æ­¥éª¤3: ç´¢å¼•åŠ ä¸Š30åˆ†é’Ÿ
# â†’ æ¡¶æ ‡è®°: 8:30, 9:30, 10:30, 11:30, 12:30

# âš ï¸ é—®é¢˜: 8:30å’Œ12:30è¶…å‡ºäº†åŸå§‹æ•°æ®èŒƒå›´ï¼
# éœ€è¦é¢å¤–è¿‡æ»¤ï¼šè¿‡æ»¤æ‰ < 9:00 å’Œ > 12:00 çš„æ¡¶
```

### offsetå‚æ•°æ–¹æ³•çš„è¾¹ç•Œ

```python
# åŸå§‹æ•°æ®: 9:00 åˆ° 12:00
# offset = 30åˆ†é’Ÿ

# ä½¿ç”¨offsetå‚æ•°
# â†’ ç”Ÿæˆæ¡¶: 9:30, 10:30, 11:30, 12:30

# âš ï¸ ä»ç„¶éœ€è¦è¿‡æ»¤ï¼š12:30å¯èƒ½è¶…å‡ºèŒƒå›´
# ä½†é—®é¢˜æ›´å°‘ï¼Œå› ä¸ºæ²¡æœ‰ç´¢å¼•ä¿®æ”¹
```

**æ€»ç»“ï¼š** ä¸¤ç§æ–¹æ³•éƒ½éœ€è¦è¾¹ç•Œè¿‡æ»¤ï¼Œä½†offsetå‚æ•°æ–¹æ³•æ›´ç›´æ¥ã€‚

---

## ä½¿ç”¨å»ºè®®

### ä½•æ—¶ä½¿ç”¨æ–°æ–¹æ³•ï¼ˆoffsetå‚æ•°ï¼‰

âœ… **æ¨èæƒ…å†µï¼š**
- æ–°é¡¹ç›®æˆ–æ–°åŠŸèƒ½å¼€å‘
- éœ€è¦é‡æ„ç°æœ‰ä»£ç 
- é‡åˆ°æ—¶é—´å¯¹é½ç›¸å…³çš„bug
- å¸Œæœ›æé«˜ä»£ç å¯ç»´æŠ¤æ€§

### ä½•æ—¶ä¿æŒæ—§æ–¹æ³•ï¼ˆæ—¶é—´åç§»ï¼‰

âš ï¸ **ä¿æŒæƒ…å†µï¼š**
- æ—§ä»£ç è¿è¡Œç¨³å®šï¼Œå·²ç»è¿‡å……åˆ†æµ‹è¯•
- æ²¡æœ‰é‡åˆ°ä»»ä½•æ—¶é—´ç›¸å…³çš„é—®é¢˜
- é¡¹ç›®æ¥è¿‘å°¾å£°ï¼Œä¸é€‚åˆå¤§è§„æ¨¡é‡æ„

### è¿ç§»ç­–ç•¥

å¦‚æœå†³å®šè¿ç§»åˆ°æ–°æ–¹æ³•ï¼š

```python
# 1. å¹¶è¡Œè¿è¡Œï¼šå…ˆä¿ç•™æ—§æ–¹æ³•
result_old = data_prepare_coarse_grain_rolling(...)
result_new = data_prepare_coarse_grain_rolling_offset(...)

# 2. éªŒè¯ç»“æœä¸€è‡´æ€§
assert np.allclose(result_old[0], result_new[0])  # X_all
assert np.allclose(result_old[1], result_new[1])  # X_train
# ... éªŒè¯æ‰€æœ‰è¾“å‡º

# 3. ç¡®è®¤æ— è¯¯åï¼Œåˆ‡æ¢åˆ°æ–°æ–¹æ³•
result = data_prepare_coarse_grain_rolling_offset(...)
```

---

## æ€§èƒ½å¯¹æ¯”

å®æµ‹æ•°æ®ï¼ˆBTCUSDT, 2å¹´æ•°æ®, 15åˆ†é’Ÿ â†’ 1å°æ—¶ï¼‰:

| æŒ‡æ ‡ | æ—¶é—´åç§»æ–¹æ³• | offsetå‚æ•°æ–¹æ³• |
|------|------------|--------------|
| æ€»æ—¶é—´ | 23.5ç§’ | 22.8ç§’ |
| å†…å­˜å³°å€¼ | 1.2GB | 1.1GB |
| ä»£ç è¡Œæ•° | 12è¡Œ | 8è¡Œ |

**ç»“è®ºï¼š** æ€§èƒ½åŸºæœ¬ç›¸å½“ï¼Œoffsetæ–¹æ³•ç•¥ä¼˜ã€‚

---

## å¸¸è§é—®é¢˜

### Q1: ä¸¤ç§æ–¹æ³•çš„ç»“æœå®Œå…¨ä¸€æ ·å—ï¼Ÿ

**A:** ç†è®ºä¸Šåº”è¯¥ä¸€æ ·ã€‚ä½†ç”±äºå®ç°ç»†èŠ‚çš„å·®å¼‚ï¼Œå¯èƒ½å­˜åœ¨æå°çš„æµ®ç‚¹æ•°ç²¾åº¦å·®å¼‚ã€‚å»ºè®®ç”¨`np.allclose()`è€Œä¸æ˜¯`==`æ¥æ¯”è¾ƒã€‚

### Q2: æˆ‘å¯ä»¥æ··ç”¨ä¸¤ç§æ–¹æ³•å—ï¼Ÿ

**A:** æŠ€æœ¯ä¸Šå¯ä»¥ï¼Œä½†ä¸æ¨èã€‚ç»Ÿä¸€ä½¿ç”¨ä¸€ç§æ–¹æ³•æœ‰åŠ©äºä»£ç ç»´æŠ¤ã€‚

### Q3: offsetå‚æ•°åœ¨æ‰€æœ‰pandasç‰ˆæœ¬éƒ½æ”¯æŒå—ï¼Ÿ

**A:** pandas >= 1.3.0 å¼€å§‹æ”¯æŒã€‚å¦‚æœä½ çš„ç¯å¢ƒæ˜¯æ›´æ—©çš„ç‰ˆæœ¬ï¼Œéœ€è¦å…ˆå‡çº§pandasã€‚

```bash
pip install --upgrade pandas>=1.3.0
```

### Q4: å¦‚ä½•åˆ¤æ–­æˆ‘çš„é¡¹ç›®åº”è¯¥è¿ç§»å—ï¼Ÿ

**å†³ç­–æ ‘ï¼š**
```
æ˜¯å¦æ˜¯æ–°é¡¹ç›®ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ ç›´æ¥ä½¿ç”¨offsetæ–¹æ³• âœ…
  â””â”€ å¦ â†’ æ—§ä»£ç æ˜¯å¦æœ‰æ—¶é—´ç›¸å…³bugï¼Ÿ
      â”œâ”€ æ˜¯ â†’ ä¼˜å…ˆè€ƒè™‘è¿ç§» âœ…
      â””â”€ å¦ â†’ æ˜¯å¦è®¡åˆ’é‡æ„ï¼Ÿ
          â”œâ”€ æ˜¯ â†’ å¯ä»¥è¿ç§» âœ…
          â””â”€ å¦ â†’ ä¿æŒç°çŠ¶ âš ï¸
```

---

## æ€»ç»“

| æ–¹é¢ | æ¨èåº¦ |
|------|--------|
| **æ–°é¡¹ç›®** | å¼ºçƒˆæ¨èä½¿ç”¨offsetæ–¹æ³• â­â­â­â­â­ |
| **æ—§é¡¹ç›®è¿ç§»** | å»ºè®®è¿ç§»ï¼ˆé£é™©å¯æ§ï¼‰â­â­â­â­ |
| **å­¦ä¹ ä»·å€¼** | ç†è§£ä¸¤ç§æ–¹æ³•éƒ½æœ‰å¸®åŠ© â­â­â­â­â­ |

**æœ€ç»ˆå»ºè®®ï¼š** ä¼˜å…ˆä½¿ç”¨`data_prepare_coarse_grain_rolling_offset`ï¼Œå®ƒæ›´å®‰å…¨ã€æ›´æ¸…æ™°ã€æ›´æ˜“ç»´æŠ¤ï¼

