三层结构

**把因子分成「Alpha / Regime / 风控&拥挤度」三层，比“全部扔进一个预测模型”更符合大多数机构量化的工程实践：优点是可控、稳健、易解释，缺点是可能放弃一部分非线性收益；而“全扔进一个模型”偏研究/原型思路，在真实资金上直接这么干的主流并不多。对你现在的 crypto 杠杆策略，三层结构是更安全、更工程化的选择。**

**1. 三层结构 vs 全部丢进模型：核心区别**

**三层结构：**

* 设计思想：
* Alpha 层：只用“方向性、收益相关”的量价因子，最大化挖 alpha。
* Regime 层：只判断“现在是不是适合用这个 alpha、该多大仓位”，不直接赚钱。
* 风控 & 拥挤度层：只做“越危险越减仓”的单调控制，不去赌方向。
* 等价于： **你先问「该不该做、做多还是做空」→ 再问「在这个环境下，做多/做空要多激进」→ 最后问「杠杆/拥挤度能不能这么冲」** 。

**全部丢进一个模型：**

* 设计思想：
* 不区分因子角色：趋势、波动、impact、oi、拥挤度全变成一堆 feature；
* 统一让模型学「给我一个最终的 score / 仓位」。
* 等价于：**让模型自己决定什么时候做、做多做空多少，顺带决定高冲击/高拥挤时到底是加仓还是减仓。**

**2. 三层结构的优势**

* **1）风控约束可以写死，避免“模型学坏”**
* 你直觉上不能接受的行为：
* Amihud 极高 + gap 频繁 + taker_imbalance_vol 拉满 → 模型反而加仓；
* OI z-score、toptrader skew、funding 全在历史高位 → 模型说“还在涨，继续满仓多”。
* 如果这些因子在风控层、只能通过**单调递减函数**缩放仓位，这种行为在结构上就被禁止了。
* 全扔进一个模型，哪怕加 L1/L2 正则，只要回测里“高拥挤 + 最后一冲还在涨”的样本多，模型就有动力学出“拥挤高 → 更多多头”。
* **2）解释性与可调性强**
* 三层结构，你能非常清楚地说：
* Alpha 层赚的是「趋势/反转/价量」的钱；
* Regime 层只是在“高波震荡 / 死水”少交易；
* 拥挤度层只是在“杠杆过高”自动收仓。
* 反过来调参数也方便：
* 测试发现高波震荡段回撤太大 → 只改 Regime gating；
* 发现极端拥挤段踩雷 → 只强化拥挤度缩放函数。
* 全扔进一个黑箱模型，回撤出问题时，很难拆出“到底是 trend 因子问题、还是拥挤度用反了”。
* **3）对样本量要求更低，更适合 crypto / 高频**
* Crypto、15m 级别， **事件很稀疏** ：真正极端拥挤 + 瀑布的样本并不多；
* 要模型同时学「趋势怎么赚钱」+「高拥挤时要减仓」这样的复杂非线性，需要大量多周期、多 regime 的样本；
* 三层拆开之后：
* Alpha 层主要吃“日常数据”，样本多，容易学；
* 风控层直接用 **规则 + 单调函数** ，不强求从稀少的极端样本中学复杂 pattern。
* **4）工程上更接近真实风控 / 投委会约束**
* 机构里常见的是：
* Alpha 模型可以换、可以多；
* 但“单日最大回撤不超过 x”、“单边杠杆不超过 y”、“某些欠流动板块仓位 capped”是风险委员会写死的。
* 三层结构天然适配：底层随便迭代因子和模型，上层风控框架相对稳定。

**3. 三层结构的劣势 / 代价**

* **1）可能“少赚”一部分真实存在的复杂交互**
* 现实中确实存在：
* “在适度拥挤 + 上升期，顺着主力多头冲一段”是赚钱机会；
* 某些 regime 下，“高 impact 反而代表抢筹，短期 follow 更好赚”。
* 三层结构只允许“拥挤/冲击增加 → 最多不加仓 / 减仓”，等于在结构上禁止了“利用这些因子的正向 alpha”，这部分潜在 alpha 会被你主动放弃。
* **2）需要你手工设计更多规则 / 函数形状**
* 例如：
* Regime score 怎么构？
* 拥挤度多高开始缩仓？线性缩？指数缩？
* 这些都要你根据经验和回测调整，而不是交给模型 end-to-end 学。
* **3）优化不是“全局最优”而是“分块近似最优”**
* 理论上，若你有足够数据和完美模型，一个 end-to-end 学到的决策函数，能 joint optimize：
* 在不同 Regime 下应该偏哪种风格、
* 在不同拥挤度下应该开多大仓位。
* 三层结构是把问题拆成更可控的小块，牺牲了“可能存在的全局交互最优”，换来可解释和稳健。

**4. “全部丢进一个预测模型”的优劣**

**优势：**

* **1）理论表达力更强**
* 尤其是 XGB/LGB/NN 这类非线性模型：
* 可以自动挖掘 “trend × regime × crowding” 的交互，
* 也可能学到非常细颗粒度的 conditional pattern（比如“在牛市后半段 + 资金未过度拥挤时，oi_zscore 升高是好事；但在极端高位时，oi_zscore 继续升高是坏事”）。
* **2）alpha 与风控的信息可以 joint use**
* 一些 impact/拥挤因子本身可能带有 alpha 信息（如大口主买方不一定意味着立刻跌），all-in-one 模型有机会把其中的一部分利用起来，而不是一刀切当风控。

**劣势：**

* **1）容易学出“违反风险常识”的策略**
* 回测期间，只要某些“高拥挤 + 高 impact + 继续冲高”的样本表现很好，模型就有动力学出「在这类状态下继续加多」；
* 而这恰恰是你在文档里最怕的“清算瀑布前最后一冲”；
* 如果成本、流动性约束在回测中没被真实建模（现实通常做不到完全精确），all-in-one 模型极易过拟合这类“纸面无风险、实盘巨坑”的 pattern。
* **2）debug 极难**
* 回撤大了，你很难回答：
* 是 trend 因子失效？
* 还是模型在高波 regime 下乱冲？
* 还是拥挤度信号没被正确利用？
* 升级 / 修补策略时，没有清晰的干预点。
* **3）对样本量、正则化、CV 要求极高**
* 特别是时间序列 + 高频 + regime 多变的环境，要同时学好这么多交互，需要：
* 很长历史、
* 很强的 AFML 式 cross-validation（purged CV + embargo）、
* 以及非常小心的特征选择。

**5. 行业主流是怎样的？**

**更接近现实的主流是：**

1. **不把所有东西都扔进一个 end-to-end 黑箱** ，而是：

* 把 Alphα 模型和 Risk/Regime 模型，至少在概念层面分开；
* 使用类似你现在这种「信号层（多因子）+ Regime/gating 层 + 风控/约束层」的结构。

1. **Alpha 模型本身会用有限子集的特征** （比如只用 momentum + value + carry + quality 等），而：

* 交易成本、冲击、杠杆/拥挤度更多是作为 **约束、position scaling、meta-label gating** 存在，而不是“和 Alpha 同权的输入特征”。

1. **在一些更大资金 /更成熟的团队**中，会在三层结构上再加一层“meta-model”：

* 比如用 ML 学 “在不同 Regime 下不同风格（趋势、反转、carry）的权重”，
* 但依然会对 impact/crowding 施加硬约束或单调约束（不允许越高杠杆越激进）。

**6. 对你当前项目的建议（结合上面分析）**

* **你的数据特点** ：crypto / 币本位合约、15m 级别、拥挤度/impact 因子非常重要，极端事件（清算瀑布）少但杀伤力大。
* **资源特点** ：已经有一套 GP 挖 Alpha + 多模型组合 + Triple Barrier + 回测框架；风控需求相对强。

在这种环境下：

* **更推荐** **：**
* 继续采用 **三层结构 + 局部 ML** 的框架：
* Alpha 层：GP + LR/XGB/LGB 挖量价/趋势因子；
* Regime 层：简单模型（甚至规则函数）识别“高波震荡、死水”；
* 风控层：拥挤度/impact 单调缩放 + 硬约束。

1. **Alpha 模型** ：

* 基于资产定价/经验因子，专注预测“相对收益/超额收益”，尽量保持可解释、可拆分因子贡献；

1. **Regime / Style Allocation 模型** ：

* 基于经济/波动/流动性 Regime 决定「哪些 Alpha 风格在当前 regime 下开启、给多大权重」；

1. **Risk & Constraints 层** ：

* 基于风险预算、流动性、拥挤度、法定&内部约束（VaR、leverage limit、sector limit 等）决定「整体杠杆和仓位上限」，通常以**单调函数/硬约束**形式存在。
