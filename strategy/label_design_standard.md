判断一个 Label（标签）处理方式是否“更好”，在量化里不能只靠感觉，必须通过**A/B Test（对照实验）**和**统计指标**来量化评估。

在 gplearn 的语境下，“好”的 Label 意味着它能 **引导遗传算法更快地收敛** ，且挖掘出的因子在 **样本外（OOS）更稳定** 。

你可以通过以下 **4 个维度** 来判定你的新 Label（平滑+波动率标准化）是否优于原先的（裸 Log Return）：

---

### 一、 直观维度：信噪比测试 (Signal-to-Noise Check)

最简单的方法是画图观察。取一段典型的 **“插针行情”** 和 **“不同波动率行情”** 进行对比。

* 测试方法：
  画出 Close Price，叠加原来的 Label 和新的 Label。
* **判断标准：**
  1. **抗插针：** 当价格瞬间向下插针 5% 又拉回时：
     * *旧 Label:* 数值剧烈跳动（如 -3.0），认为是极度看空。
     * *新 Label:* 应该保持相对平稳（因为使用了均价平滑），不被瞬间噪音带偏。
  2. **跨周期公平性：** 对比 2021 年（高波）和 2023 年（低波）：
     * *旧 Label:* 2021 年的值在 [-0.1, 0.1]，2023 年在 [-0.01, 0.01]。模型会完全忽视 2023 年。
     * *新 Label:* 两段时间的值应该都在 [-3, 3] 左右分布。

---

### 二、 训练过程维度：收敛效率 (Fitness Curve)

这是评价 gplearn **“学得舒不舒服”** 的核心指标。

* 测试方法：
  设定相同的 gplearn 参数（种群大小、代数、随机种子），分别用两套 Label 跑训练。
* **观察指标：**
  1. **平均适应度 (Average Fitness):** 每一代种群的平均分。
     * *更好:* 新 Label 的平均分应该上升得更快，且更平滑。
  2. **最佳适应度 (Best Fitness):** 每一代的最强因子分数。
     * *更好:* 如果新 Label 能让 GP 更早找到高分因子，说明 Label 的梯度更清晰。
  3. **公式复杂度 (Program Length):**
     * *更好:* 在同等分数下，新 Label 挖出来的公式通常更短、更简洁。因为规律更明显，不需要复杂的嵌套去拟合噪音。

---

### 三、 结果质量维度：因子 IC 表现 (IC Metrics)

这是**最硬核**的判断标准。你需要把两组挖出来的 Top 5 因子，放到**验证集（Validation Set）**上跑绩效。

**注意：** 无论用什么 Label 训练， **评估的时候必须统一用“原始收益率”来计算 IC** （因为最终是靠原始涨跌赚钱）。

* **测试方法：**
  * **Group A:** 用旧 Label 挖出的因子 **$F_{old}$**。
  * **Group B:** 用新 Label 挖出的因子 **$F_{new}$**。
  * **Benchmark:** 计算 **$F_{old}$** 和 **$F_{new}$** 与未来真实收益率（Raw Return）的 Rank IC。
* **核心指标：**
  1. **IC Mean (IC 均值):**
     * *判断:* **$F_{new}$** 的 IC 绝对值通常会更高（因为去除了噪音干扰）。
  2. **IC Std (IC 波动率):**
     * *判断:* **$F_{new}$** 的 IC 波动应该更小。旧 Label 挖出的因子往往在震荡市 IC 接近 0，在单边市 IC 很高；新 Label 挖出的因子应该更稳定。
  3. **ICIR (信息比率 = Mean / Std):**
     * *判断:* **这是决定性指标。** 谁的 ICIR 高，谁就赢。通常经过 Vol-Scaling 的 Label，ICIR 会显著提升（例如从 0.05 提升到 0.08）。
  4. **因子的自相关性 (Factor Autocorrelation):**
     * *判断:* 新 Label 挖出的因子，自相关性通常更高（曲线更平滑），这意味着换手率更低，实盘交易成本更低。

---

### 四、 实战模拟：分层回测 (Layered Backtest)

如果不放心 IC，直接看分层回测的净值曲线。

* 测试方法：
  取验证集数据，根据 $F_{old}$ 和 $F_{new}$ 的值分为 5 组（Top 20% 到 Bottom 20%），计算多空对冲净值。
* **判断标准：**
  1. **单调性 (Monotonicity):** 第 1 组收益 > 第 2 组 > ... > 第 5 组。新 Label 挖出的因子单调性通常更好。
  2. **最大回撤 (Max Drawdown):** 关注净值曲线的回撤。
     * *旧 Label:* 容易在市场风格切换（如从牛转熊）时出现大幅回撤。
     * *新 Label:* 由于做了波动率标准化，因子在不同市场状态下的表现应该更一致，回撤更小。

---

### 🚀 总结：给你的 A/B Test 执行清单

你可以写一个脚本，跑以下流程，一目了然：

1. **准备数据：**
   * `Y_raw`: 原始 Log Return（旧方案）。
   * `Y_new`: 平滑 + Vol-Scaled + GaussRank（新方案）。
2. **挖掘：**
   * 用 `Y_raw` 跑 gplearn，取最佳因子公式 `Formula_A`。
   * 用 `Y_new` 跑 gplearn，取最佳因子公式 `Formula_B`。
3. **评估 (使用样本外数据 2024年):**
   * 计算 `Formula_A` 和 `Formula_B` 的因子值。
   * 计算它们与 `Raw Return` 的 Rank IC。
   * **结论：**
     * 如果 `ICIR(B) > ICIR(A)` **$\rightarrow$** 新方案胜出。
     * 如果 `Formula_B` 的换手率远低于 `Formula_A` **$\rightarrow$** 新方案胜出（抗噪音成功）。

经验之谈：

在 Crypto 小时级数据上，**波动率标准化（Vol-Scaling）**通常能让 ICIR 提升 30%-50%，因为它解决了“除了暴涨暴跌时刻，其他时间机器都在瞎猜”的问题。
