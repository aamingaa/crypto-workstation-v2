### 动量（Momentum）相关描述（适合作为 `mom.md` 文档框架）

**动量策略的核心，是捕捉“趋势的持续性”，而不是预测拐点。** 在小时级别的 Crypto 永续合约市场，动量往往来自于：价格单边推进 + 真实资金持续进场 + 有利的波动环境。

---

### 一、核心市场假设：为什么价格会“继续朝一个方向走”？

1. **趋势惯性（Price Inertia）**

   - 假设：价格一旦在一段时间内单边上行/下行，说明市场形成了一致预期（Narrative），短期内不会立刻反转。
   - 现象：突破区间后的“顺势走一段”，而不是立刻打回区间。
2. **资金推动（Capital Inflow）**

   - 假设：只有当**新资金持续进场**（OI 增长、主动买盘占优），价格趋势才具有可持续性。
   - 现象：价格上涨 + OI 放大 + TakerBuy 明显大于 TakerSell，往往是“真趋势”。
3. **波动环境配合（Vol Regime）**

   - 假设：
     - 在长期低波动、短期突然放量突破时，动量延续概率大（趋势启动）。
     - 在本就极高波动的环境中突破，往往是假突破/短期情绪宣泄，容易反转。

---

### 二、因子拆分与数学构造（Feature Engineering）

为了让 gplearn 捕捉动量的不同维度，建议从 **价格强度、资金流/持仓、波动环境** 三个维度构造中间变量。

#### 1. 价格强度类（Price Strength Momentum）

- **超短期相对强度（Short-Term ROC Spread）**

\[
Factor_1 = \text{ts\_delta}(Close, \tau_1) - \text{ts\_delta}(Close, \tau_2)
\]

- 逻辑：比较短周期（如 \(\tau_1 = 4\) 小时）与中周期（如 \(\tau_2 = 12\) 小时）的涨跌幅差异；短期涨幅显著高于长期 → 动量在加速。
- **标准化价格动量（Vol-Normalized Momentum）**

\[
Factor_2 = \frac{Close - \text{ts\_delay}(Close, \tau)}{\text{ts\_std}(Return, \tau)}
\]

- 逻辑：收益率 ÷ 波动率，刻画“单位风险的趋势强度”；涨得多且稳（分母小） → 高质量趋势。
- **路径效率（Path Purity）**

\[
Factor_3 = \frac{\text{abs}(Close - \text{ts\_delay}(Close, 24))}{\text{ts\_sum}(\text{abs}(Close - \text{ts\_delay}(Close, 1)), 24)}
\]

- 逻辑：衡量过去 24 小时是“直线趋势”还是“来回震荡”；值接近 1 → 几乎直线拉升/下跌 → 纯净动量。

#### 2. 资金流与持仓类（Flow & OI Momentum）

- **增仓动量（Open Interest Momentum）**

\[
Factor_4 = \text{ts\_delta}(OpenInterest, 4) \times \text{sign}(\text{ts\_delta}(Close, 4))
\]

- 逻辑：

  - 价格上涨 + OI 上升 → 新资金顺势加仓，多头趋势真实且可持续；
  - 价格上涨 + OI 下降 → 空头回补主导，更偏“挤空反弹”，动量质量差。
- **主动流强度（Taker Flow Strength）**

\[
Factor_5 = \text{ts\_mean}(TakerBuyVolume - TakerSellVolume, 6)
\]

- 逻辑：过去 6 小时净主动买入（或卖出）的强度；持续净买入 → 趋势有微观资金支撑。

#### 3. 波动环境过滤（Vol-Regime Filter）

- **波动率过滤器（Vol Filter）**

\[
Filter = \frac{\text{ts\_std}(Return, 12)}{\text{ts\_std}(Return, 72)}
\]

- 逻辑：短期波动 / 长期波动：
  - \(Filter < 1\)：短期比长期更平静 → 突破时更可能走出**趋势行情**；
  - \(Filter \gg 1\)：短期波动已经极高 → 更容易是假突破/情绪尖峰。

---

### 三、怎么让 gplearn 挖掘“顺势 + 过滤假突破”的组合？

- **方向建议（Fitness 导向）**

  - 让 gplearn 学习类似逻辑：
    - “当价格动量强 **且** OI 增长 **且** 主动净买入为正 **且** 处于低波环境时，做多；
      当价格动量强 **且** OI 增长 **且** 主动净卖出为正时，做空。”
- **结构示例（给 gplearn 的 Seeds）**

$$
Alpha \approx \text{sign}(Factor_1) \times (1 + Factor_4) \times \frac{1}{1 + Filter}
$$

- 含义：
  - `sign(Factor_1)`：趋势方向；
  - `Factor_4`：资金是否跟随趋势；
  - `1 / (1 + Filter)`：在低波环境中放大动量信号，在高波环境中抑制。

---

### 四、避坑指南：如何让动量策略更鲁棒？

1. **防止追在“趋势尾巴”上**

   - 在因子层面加入 **“趋势年龄/累积涨幅”** 约束：
     - 累积涨幅过大、趋势持续时间过长 → 因子自动衰减，避免在尾声孤注一掷。
2. **识别假突破**

   - 价格突破但：
     - OI 不增反减，或
     - 主动买/卖净流不配合，
       则因子应降低权重甚至反向，避免被情绪尖刺扫掉。
3. **与均值回归因子的冲突处理**

   - 同一时间窗口内，动量因子与均值回归因子强烈对冲时：
     - 可以在组合层面引入 **Regime Switch / Meta-Labeling**：
       例如用 Vol Filter 或 Trend Filter 决定“此时优先信动量还是信回归”。

---

### 简短总结

- **价格强度**：回答“涨/跌得有多快、多稳？”
- **资金流与持仓**：回答“这波趋势背后有真金白银吗？”
- **波动环境**：回答“现在是容易走趋势，还是容易假突破？”

这样的三层拆分，非常适合交给 gplearn 做非线性组合，让它自动学习类似
**“if（低波 + 价格加速 + OI 增长 + 主动净买入）then（顺势加仓）”** 的高阶逻辑。



为了让你的 gplearn 挖掘出更具鲁棒性的策略，建议在你的因子库（Terminals）中补充以下两个维度：

**A. 资金费率斜率 (Funding Rate Slope)**

不要只看费率的大小，要看费率的变化方向。

$$
Factor_{funding\_bias} = \text{ts\_delta}(\text{FundingRate}, 3)
$$

* **逻辑** ：如果价格上涨但费率在下降，说明多头力量主要来自于现货或非杠杆头寸，或者空头在疯狂抵抗（可能被爆仓），这通常预示着更大的挤压空间。

**B. 极端清算压力 (Liquidation Pressure)**

小时级别往往是“爆仓触发”的高发区。

$$
Factor_{liq} = \frac{\text{Long\_Liquidation} - \text{Short\_Liquidation}}{\text{Volume}}
$$

* **逻辑** ：如果过去 1-2 小时出现了大规模空头清算（Short Liq），往往动量已经衰竭。让 GP 学习“当清算量激增时，动量因子权重降低”。

识别“假突破”（False Breakout/Bull/Bear Trap）是小时级别量化策略提高胜率的关键。假突破本质上是 **流动性陷阱** ：大户利用散户的突破追随心理，通过诱多/诱空来获取对手盘，从而完成大规模头寸的平仓或反手建仓。

针对 Crypto 合约市场，我们可以从**持仓异动、成交质量、波动一致性、形态压力**四个维度设计更精细的特征。

**一、 持仓与清算维度（最核心的判别依据）**

在合约市场，没有持仓支撑的突破都是“耍流氓”。

**1. 突破效率比（OI-Price Efficiency）**

* **公式** ：$Factor = \frac{\Delta Price / Price}{\Delta OI / OI}$
* **逻辑** ：在突破瞬间，如果价格大幅波动但持仓量（OI）几乎不动甚至下降，说明这波突破主要是由**存量资金的相互博弈（平仓/挤仓）**引起的，而非新资金入场。
* **假突破特征** ：价格突破 + OI 下降（空头止损驱动，动力不可持续）。

**2. 清算占比（Liquidation Intensity）**

* **公式** ：$Factor = \frac{Short\_Liquidation}{Volume}$ （向上突破时）
* **逻辑** ：衡量突破时的成交量里，有多少是被迫平仓贡献的。
* **假突破特征** ：如果 $Factor$ 极高，说明这波拉升是典型的“爆空头”，一旦空头爆完，买压就会瞬间枯竭，价格极易回落。

**二、 主动成交细节（CVD 与 Taker 行为）**

主动成交（Market Order）反映了市场最急迫的情绪。

**3. CVD 背离度（CVD Divergence）**

* **特征构造** ：计算过去 $N$ 小时价格斜率与 CVD（累积成交均量线）斜率的差异。
* **逻辑** **：**
* **真突破** ：价格突破前高，CVD 也突破前高（主动买盘强劲）。
* **假突破** ：价格创出新高，但 CVD 无法创出新高（顶背离），说明突破是靠挂单买盘（Passive Buy）或流动性缺失推升的，主动买盘已衰竭。

**4. 平均主动成交大小（Avg Taker Size）**

* **公式** ：$Factor = \frac{Taker\_Volume}{Taker\_Trade\_Count}$
* **逻辑** ：衡量“大户”是否在参与突破。
* **假突破特征** ：如果价格突破时成交笔数暴增，但单笔平均成交金额反而下降，说明是散户在追涨，大户可能在反向挂单出货。

**三、 微观结构与形态（K线“物理学”）**

**5. 上影线压力比（Wick Ratio）**

* **公式** ：$Wick\_Ratio = \frac{High - \max(Open, Close)}{High - Low}$
* **逻辑** ：在小时线收盘前，衡量价格被砸回来的程度。
* **精细化改进** ：不要只看单根，看过去 3 小时的累计上影线长度。
* **gplearn 逻辑** ：如果 ts_max(Wick_Ratio, 3) > 0.6，则对动量因子进行大幅度惩罚。

**6. 突破区间的停留时间（Time Above Level）**

* **特征构造** ：在 $N$ 分钟（或更细颗粒度）内，价格维持在压力位上方的时间占比。
* **逻辑** ：真突破往往伴随着放量加速，迅速拉开与成本区的距离；假突破往往在压力位上方反复“磨损”，无法有效拉开距离。
* **公式示例** ：$\text{Count}(Price_{min} > Level) / \text{Total\_Minutes}$。

**四、 波动一致性（Regime Check）**

**7. 异常波动得分（Z-Score of Volatility）**

* **公式** ：$Factor = \frac{Return_{current} - \text{ts\_mean}(Return, 72)}{\text{ts\_std}(Return, 72)}$
* **逻辑** **：**
* 如果 $Factor$ 在 1~2 之间，属于稳健动量。
* 如果 $Factor > 4$（超强偏离），在小时级别通常意味着情绪过热，是假突破的高发区。

**8. 成交量分布熵（Volume Entropy）**

* **逻辑** ：衡量成交量在不同价位的分布。
* **真突破** ：成交量在突破点上方均匀分布（换手充分）。
* **假突破** ：成交量极度集中在突破点那一个价位，随后迅速缩量（真空状态）。

**五、 如何在 gplearn 中实现这些“假突破”识别？**

你可以为 gplearn 提供一套**“逻辑门（Logic Gates）”**，让它学习如何通过这些特征过滤掉坏信号。

1. 定义“真突破权重”算子：

$$
Weight = \text{If}(OI\_Change > 0 \text{ AND } CVD\_Slope > 0, 1, 0.2)
$$

这意味着：只有当持仓增加且主动买盘配合时，才给动量因子 1 的权重；否则只给 0.2。

2. 构造“反转预警”种子：

$$
Alpha\_Fake = \text{Add}(\text{Wick\_Ratio}, \text{Liq\_Intensity}) \times \text{Momentum}
$$

让 GP 学习：当上影线大且爆仓量大时，原有的动量因子应该被抵消甚至反转。

**3. 给 gplearn 的 Terminals（特征输入列表）建议：**

* oi_delta_norm: 归一化的持仓变化。
* taker_imb: 主动买卖盘不平衡度。
* wick_purity: 上影线占比。
* vol_spike: 当前成交量对比 24h 均值。
* distance_to_max: 距离过去 100 小时最高点的距离。

**总结**

识别假突破的核心在于：**“不仅要看价格走到了哪里，更要看它走过去的方式是否健康。”** 一个健康的小时级突破应该是：**持仓平稳增长（不是暴增也不是暴减）+ CVD 稳步上扬 + 波动率温和放大（不是垂直拉升）+ 成交量分布均匀。** 如果你能把这些逻辑封装成原子因子喂给 gplearn，它挖掘出的策略鲁棒性会比单纯用 MACD/RSI 类指标强出几个量级。

这段关于动量策略和假突破识别的论述 **含金量非常高** 。

评价总结：

这不仅仅是普通的“技术分析”，而是典型的 Crypto 机构化/中高频量化（HFT-lite）思维在小时级别上的降维应用。

由于你引入了**微观结构数据（OI、Liquidation、CVD）**来辅助小时级别的 K 线数据，这直接解决了纯价量因子（Price-Volume Factors）在 Crypto 市场中“信噪比低”的核心痛点。

如果能把这套逻辑落实到 gplearn 中，你的策略上限会非常高。

为了帮你把这套逻辑打磨得更锋利，我将从**因子工程的陷阱、逻辑完善、以及 gplearn 的算子适配**三个角度给出评价和优化建议：

**一、 对“核心市场假设”的深度复盘**

你对 Crypto 市场动量的三个归因（清算、情绪级联、信息滞后）非常精准。

唯一的补充建议： 注意 “资金费率套利（Funding Arbitrage）” 对动量的干扰。

* **现有的逻辑漏洞：** 有时价格上涨、OI 上涨，看似是动量增强，但如果此时 Funding Rate 极高（> 0.05% / 8h），大量的资金其实是“现货买入 + 合约做空”进场吃费率的套利盘。这部分 OI 是**中性**的，甚至会形成上方的压单（因为套利者需要在高位挂单开空）。
* **优化方案：** 在“增仓动量”因子中，剔除掉费率极高时段的 OI 增长，或者将 OI 增长与费率做负相关处理。

**二、 对“因子数学构造”的优化建议**

公式大部分都很漂亮，但有几个在机器学习（gplearn）中可能会有**数据平稳性（Stationarity）**问题。

**1. 价格强度类：修正非平稳项**

* **原公式：** ts_delta(Close, 4) - ts_delta(Close, 12)
* **问题：** BTC 价格在 20,000 和 60,000 时，绝对差值（Delta）的量级完全不同。gplearn 训练出的系数会失效。
* 修正： 必须使用对数收益率或百分比变化。

  $$
  Factor = \text{ts\_sum}(\ln(1+Ret), 4) - \text{ts\_sum}(\ln(1+Ret), 12)
  $$

**2. 资金流类：CVD 的标准化痛点**

* **问题：** TakerBuy - TakerSell 的绝对值也受成交量基数影响。牛市的净买入 100M 和熊市的 100M 意义不同。
* 修正： 建议除以总成交量，将其转化为比率（Ratio）。

  $$
  Factor = \frac{\text{ts\_mean}(TakerBuy - TakerSell, 6)}{\text{ts\_mean}(Volume, 6)}
  $$

  这样因子值永远在 [-1, 1] 之间，对 gplearn 极其友好。

**3. 波动率过滤器：分母为零的保护**

* **问题：** Crypto 偶尔会出现横盘死寂（极低波动），分母过小会导致因子爆炸（Infinity），破坏整个种群的进化。
* 技巧： 在所有除法操作中加入极小常数 $\epsilon$。

  $$
  Factor = \frac{\dots}{\text{ts\_std}(\dots) + 1e-6}
  $$

**三、 对“假突破”识别的补充（Gplearn 适配版）**

你提到的“假突破”维度非常精彩，特别是**Wick Ratio**和 **OI Efficiency** 。在 gplearn 中，我们不需要硬写 If-Else，而是应该构造 **连续的惩罚函数** 。

**1. 关于“清算占比”的逻辑反转**

你提到“清算占比高 = 假突破/不可持续”，这在**突破后**是成立的。

* **但在突破前/突破瞬间：** 巨大的清算量往往是价格的燃料（Fuel）。
* **建议拆分：**
  * Liq_Ignition (点火): 价格刚过关键位 + 高清算 =  **正向权重** （助推）。
  * Liq_Exhaustion (衰竭): 价格已远离关键位 + 依然高清算 =  **负向权重** （最后一只博傻的空头被杀完了，没人买单了）。

**2. 引入“期限结构”作为过滤器（Term Structure）**

你是在做合约，利用次季合约（Quarterly）和永续合约（Perp）的价差是一个极强的假突破识别器。

* **逻辑：** 如果 Perp 价格突破新高，但次季合约没有跟进（或者溢价率 (Quarterly - Perp) / Perp 在下降），说明这波突破主要是由高杠杆投机驱动，而非机构看长远。
* 因子构造：

  $$
  Factor = \text{Rank}(\text{Price}_{\text{Perp}}) - \text{Rank}(\text{Price}_{\text{Quarterly}})
  $$

**四、 如何在 gplearn 中具体落地？（实操建议）**

既然你有清晰的逻辑，不要把所有逻辑写死在一个大公式里，建议采用 **“分层挖掘 + 组合”** 的策略：

**第一步：构建基础语义库（Primitives）**

不要只给 Open, High, Low。把经过预处理的高级特征直接喂给 gplearn 的 function_set 或 feature_names。

* **Input 1 (Trend):** RSI_14, Dist_to_MA24, Bollinger_Width
* **Input 2 (Micro):** CVD_Ratio, OI_Change_Norm, Liq_Ratio
* **Input 3 (Pattern):** Wick_Ratio, Body_Len_Ratio

**第二步：定制适应度函数（Fitness Function）**

不要只用 IC (Information Coefficient) 或 Returns。你的假设里强调了“假突破”和“动态退出”。

* **建议 Fitness：** **Sortino Ratio (只惩罚下行波动)** 或  **Calmar Ratio (收益/最大回撤)** 。
* 这会迫使 gplearn 进化出那种“看到假突破信号就自动空仓/平仓”的公式，因为它必须极力避免大回撤。

**第三步：算子工程（Function Set）**

除了加减乘除，必须加入逻辑算子，让 GP 能学会“开关”逻辑：

* max(A, B), min(A, B): 用于模拟止损线或支撑位。
* ifelse(A, B, C): 类似于 A > 0 ? B : C（通常用 analytical_quotient 近似或直接自定义）。
* sigmoid(A): 将因子值压缩到 (0, 1) 区间，充当门控信号。

**五、 总结评价**

你这段描述的逻辑完整度已经超过了 90% 的散户策略，达到了专业量化的门槛。

下一步最关键的动作：

“去噪”。

Crypto 小时级数据的噪音非常大。你设计的因子（如 OI 变化、主动买卖）如果不做平滑（Smoothing）或去极值（Winsorizing）处理，直接扔进 gplearn，很可能会挖掘出只适应某几次极端行情的“过拟合怪兽”。

建议的行动点：

先不要急着挖掘。把所有提到的因子（**OI**效率、**CVD**背离、**Wick**占比）先写成** Python **代码，画出累积收益曲线（或者和价格叠加画图），肉眼观察一下它们在** 2023 **年震荡市和** 2024 **年趋势市的表现。如果肉眼看着都有逻辑，再喂给** gplearn **组装。



为了让你的 gplearn 挖掘出更具鲁棒性的策略，建议在你的因子库（Terminals）中补充以下两个维度：

**A. 资金费率斜率 (Funding Rate Slope)**

不要只看费率的大小，要看费率的变化方向。

$$
Factor_{funding\_bias} = \text{ts\_delta}(\text{FundingRate}, 3)
$$

* **逻辑** ：如果价格上涨但费率在下降，说明多头力量主要来自于现货或非杠杆头寸，或者空头在疯狂抵抗（可能被爆仓），这通常预示着更大的挤压空间。

**B. 极端清算压力 (Liquidation Pressure)**

小时级别往往是“爆仓触发”的高发区。

$$
Factor_{liq} = \frac{\text{Long\_Liquidation} - \text{Short\_Liquidation}}{\text{Volume}}
$$

* **逻辑** ：如果过去 1-2 小时出现了大规模空头清算（Short Liq），往往动量已经衰竭。让 GP 学习“当清算量激增时，动量因子权重降低”。

识别“假突破”（False Breakout/Bull/Bear Trap）是小时级别量化策略提高胜率的关键。假突破本质上是 **流动性陷阱** ：大户利用散户的突破追随心理，通过诱多/诱空来获取对手盘，从而完成大规模头寸的平仓或反手建仓。

针对 Crypto 合约市场，我们可以从**持仓异动、成交质量、波动一致性、形态压力**四个维度设计更精细的特征。

**一、 持仓与清算维度（最核心的判别依据）**

在合约市场，没有持仓支撑的突破都是“耍流氓”。

**1. 突破效率比（OI-Price Efficiency）**

* **公式** ：$Factor = \frac{\Delta Price / Price}{\Delta OI / OI}$
* **逻辑** ：在突破瞬间，如果价格大幅波动但持仓量（OI）几乎不动甚至下降，说明这波突破主要是由**存量资金的相互博弈（平仓/挤仓）**引起的，而非新资金入场。
* **假突破特征** ：价格突破 + OI 下降（空头止损驱动，动力不可持续）。

**2. 清算占比（Liquidation Intensity）**

* **公式** ：$Factor = \frac{Short\_Liquidation}{Volume}$ （向上突破时）
* **逻辑** ：衡量突破时的成交量里，有多少是被迫平仓贡献的。
* **假突破特征** ：如果 $Factor$ 极高，说明这波拉升是典型的“爆空头”，一旦空头爆完，买压就会瞬间枯竭，价格极易回落。

**二、 主动成交细节（CVD 与 Taker 行为）**

主动成交（Market Order）反映了市场最急迫的情绪。

**3. CVD 背离度（CVD Divergence）**

* **特征构造** ：计算过去 $N$ 小时价格斜率与 CVD（累积成交均量线）斜率的差异。
* **逻辑** **：**
* **真突破** ：价格突破前高，CVD 也突破前高（主动买盘强劲）。
* **假突破** ：价格创出新高，但 CVD 无法创出新高（顶背离），说明突破是靠挂单买盘（Passive Buy）或流动性缺失推升的，主动买盘已衰竭。

**4. 平均主动成交大小（Avg Taker Size）**

* **公式** ：$Factor = \frac{Taker\_Volume}{Taker\_Trade\_Count}$
* **逻辑** ：衡量“大户”是否在参与突破。
* **假突破特征** ：如果价格突破时成交笔数暴增，但单笔平均成交金额反而下降，说明是散户在追涨，大户可能在反向挂单出货。

**三、 微观结构与形态（K线“物理学”）**

**5. 上影线压力比（Wick Ratio）**

* **公式** ：$Wick\_Ratio = \frac{High - \max(Open, Close)}{High - Low}$
* **逻辑** ：在小时线收盘前，衡量价格被砸回来的程度。
* **精细化改进** ：不要只看单根，看过去 3 小时的累计上影线长度。
* **gplearn 逻辑** ：如果 ts_max(Wick_Ratio, 3) > 0.6，则对动量因子进行大幅度惩罚。

**6. 突破区间的停留时间（Time Above Level）**

* **特征构造** ：在 $N$ 分钟（或更细颗粒度）内，价格维持在压力位上方的时间占比。
* **逻辑** ：真突破往往伴随着放量加速，迅速拉开与成本区的距离；假突破往往在压力位上方反复“磨损”，无法有效拉开距离。
* **公式示例** ：$\text{Count}(Price_{min} > Level) / \text{Total\_Minutes}$。

**四、 波动一致性（Regime Check）**

**7. 异常波动得分（Z-Score of Volatility）**

* **公式** ：$Factor = \frac{Return_{current} - \text{ts\_mean}(Return, 72)}{\text{ts\_std}(Return, 72)}$
* **逻辑** **：**
* 如果 $Factor$ 在 1~2 之间，属于稳健动量。
* 如果 $Factor > 4$（超强偏离），在小时级别通常意味着情绪过热，是假突破的高发区。

**8. 成交量分布熵（Volume Entropy）**

* **逻辑** ：衡量成交量在不同价位的分布。
* **真突破** ：成交量在突破点上方均匀分布（换手充分）。
* **假突破** ：成交量极度集中在突破点那一个价位，随后迅速缩量（真空状态）。

**五、 如何在 gplearn 中实现这些“假突破”识别？**

你可以为 gplearn 提供一套**“逻辑门（Logic Gates）”**，让它学习如何通过这些特征过滤掉坏信号。

1. 定义“真突破权重”算子：

$$
Weight = \text{If}(OI\_Change > 0 \text{ AND } CVD\_Slope > 0, 1, 0.2)
$$

这意味着：只有当持仓增加且主动买盘配合时，才给动量因子 1 的权重；否则只给 0.2。

2. 构造“反转预警”种子：

$$
Alpha\_Fake = \text{Add}(\text{Wick\_Ratio}, \text{Liq\_Intensity}) \times \text{Momentum}
$$

让 GP 学习：当上影线大且爆仓量大时，原有的动量因子应该被抵消甚至反转。

**3. 给 gplearn 的 Terminals（特征输入列表）建议：**

* oi_delta_norm: 归一化的持仓变化。
* taker_imb: 主动买卖盘不平衡度。
* wick_purity: 上影线占比。
* vol_spike: 当前成交量对比 24h 均值。
* distance_to_max: 距离过去 100 小时最高点的距离。

**总结**

识别假突破的核心在于：**“不仅要看价格走到了哪里，更要看它走过去的方式是否健康。”** 一个健康的小时级突破应该是：**持仓平稳增长（不是暴增也不是暴减）+ CVD 稳步上扬 + 波动率温和放大（不是垂直拉升）+ 成交量分布均匀。** 如果你能把这些逻辑封装成原子因子喂给 gplearn，它挖掘出的策略鲁棒性会比单纯用 MACD/RSI 类指标强出几个量级。

这段关于动量策略和假突破识别的论述 **含金量非常高** 。

评价总结：

这不仅仅是普通的“技术分析”，而是典型的 Crypto 机构化/中高频量化（HFT-lite）思维在小时级别上的降维应用。

由于你引入了**微观结构数据（OI、Liquidation、CVD）**来辅助小时级别的 K 线数据，这直接解决了纯价量因子（Price-Volume Factors）在 Crypto 市场中“信噪比低”的核心痛点。

如果能把这套逻辑落实到 gplearn 中，你的策略上限会非常高。

为了帮你把这套逻辑打磨得更锋利，我将从**因子工程的陷阱、逻辑完善、以及 gplearn 的算子适配**三个角度给出评价和优化建议：

**一、 对“核心市场假设”的深度复盘**

你对 Crypto 市场动量的三个归因（清算、情绪级联、信息滞后）非常精准。

唯一的补充建议： 注意 “资金费率套利（Funding Arbitrage）” 对动量的干扰。

* **现有的逻辑漏洞：** 有时价格上涨、OI 上涨，看似是动量增强，但如果此时 Funding Rate 极高（> 0.05% / 8h），大量的资金其实是“现货买入 + 合约做空”进场吃费率的套利盘。这部分 OI 是**中性**的，甚至会形成上方的压单（因为套利者需要在高位挂单开空）。
* **优化方案：** 在“增仓动量”因子中，剔除掉费率极高时段的 OI 增长，或者将 OI 增长与费率做负相关处理。

**二、 对“因子数学构造”的优化建议**

公式大部分都很漂亮，但有几个在机器学习（gplearn）中可能会有**数据平稳性（Stationarity）**问题。

**1. 价格强度类：修正非平稳项**

* **原公式：** ts_delta(Close, 4) - ts_delta(Close, 12)
* **问题：** BTC 价格在 20,000 和 60,000 时，绝对差值（Delta）的量级完全不同。gplearn 训练出的系数会失效。
* 修正： 必须使用对数收益率或百分比变化。

  $$
  Factor = \text{ts\_sum}(\ln(1+Ret), 4) - \text{ts\_sum}(\ln(1+Ret), 12)
  $$

**2. 资金流类：CVD 的标准化痛点**

* **问题：** TakerBuy - TakerSell 的绝对值也受成交量基数影响。牛市的净买入 100M 和熊市的 100M 意义不同。
* 修正： 建议除以总成交量，将其转化为比率（Ratio）。

  $$
  Factor = \frac{\text{ts\_mean}(TakerBuy - TakerSell, 6)}{\text{ts\_mean}(Volume, 6)}
  $$

  这样因子值永远在 [-1, 1] 之间，对 gplearn 极其友好。

**3. 波动率过滤器：分母为零的保护**

* **问题：** Crypto 偶尔会出现横盘死寂（极低波动），分母过小会导致因子爆炸（Infinity），破坏整个种群的进化。
* 技巧： 在所有除法操作中加入极小常数 $\epsilon$。

  $$
  Factor = \frac{\dots}{\text{ts\_std}(\dots) + 1e-6}
  $$

**三、 对“假突破”识别的补充（Gplearn 适配版）**

你提到的“假突破”维度非常精彩，特别是**Wick Ratio**和 **OI Efficiency** 。在 gplearn 中，我们不需要硬写 If-Else，而是应该构造 **连续的惩罚函数** 。

**1. 关于“清算占比”的逻辑反转**

你提到“清算占比高 = 假突破/不可持续”，这在**突破后**是成立的。

* **但在突破前/突破瞬间：** 巨大的清算量往往是价格的燃料（Fuel）。
* **建议拆分：**
  * Liq_Ignition (点火): 价格刚过关键位 + 高清算 =  **正向权重** （助推）。
  * Liq_Exhaustion (衰竭): 价格已远离关键位 + 依然高清算 =  **负向权重** （最后一只博傻的空头被杀完了，没人买单了）。

**2. 引入“期限结构”作为过滤器（Term Structure）**

你是在做合约，利用次季合约（Quarterly）和永续合约（Perp）的价差是一个极强的假突破识别器。

* **逻辑：** 如果 Perp 价格突破新高，但次季合约没有跟进（或者溢价率 (Quarterly - Perp) / Perp 在下降），说明这波突破主要是由高杠杆投机驱动，而非机构看长远。
* 因子构造：

  $$
  Factor = \text{Rank}(\text{Price}_{\text{Perp}}) - \text{Rank}(\text{Price}_{\text{Quarterly}})
  $$

**四、 如何在 gplearn 中具体落地？（实操建议）**

既然你有清晰的逻辑，不要把所有逻辑写死在一个大公式里，建议采用 **“分层挖掘 + 组合”** 的策略：

**第一步：构建基础语义库（Primitives）**

不要只给 Open, High, Low。把经过预处理的高级特征直接喂给 gplearn 的 function_set 或 feature_names。

* **Input 1 (Trend):** RSI_14, Dist_to_MA24, Bollinger_Width
* **Input 2 (Micro):** CVD_Ratio, OI_Change_Norm, Liq_Ratio
* **Input 3 (Pattern):** Wick_Ratio, Body_Len_Ratio

**第二步：定制适应度函数（Fitness Function）**

不要只用 IC (Information Coefficient) 或 Returns。你的假设里强调了“假突破”和“动态退出”。

* **建议 Fitness：** **Sortino Ratio (只惩罚下行波动)** 或  **Calmar Ratio (收益/最大回撤)** 。
* 这会迫使 gplearn 进化出那种“看到假突破信号就自动空仓/平仓”的公式，因为它必须极力避免大回撤。

**第三步：算子工程（Function Set）**

除了加减乘除，必须加入逻辑算子，让 GP 能学会“开关”逻辑：

* max(A, B), min(A, B): 用于模拟止损线或支撑位。
* ifelse(A, B, C): 类似于 A > 0 ? B : C（通常用 analytical_quotient 近似或直接自定义）。
* sigmoid(A): 将因子值压缩到 (0, 1) 区间，充当门控信号。

**五、 总结评价**

你这段描述的逻辑完整度已经超过了 90% 的散户策略，达到了专业量化的门槛。

下一步最关键的动作：

“去噪”。

Crypto 小时级数据的噪音非常大。你设计的因子（如 OI 变化、主动买卖）如果不做平滑（Smoothing）或去极值（Winsorizing）处理，直接扔进 gplearn，很可能会挖掘出只适应某几次极端行情的“过拟合怪兽”。

建议的行动点：

先不要急着挖掘。把所有提到的因子（**OI**效率、**CVD**背离、**Wick**占比）先写成** Python **代码，画出累积收益曲线（或者和价格叠加画图），肉眼观察一下它们在** 2023 **年震荡市和** 2024 **年趋势市的表现。如果肉眼看着都有逻辑，再喂给** gplearn **组装。
